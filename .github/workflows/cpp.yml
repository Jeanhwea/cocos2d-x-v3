name: Test Create New CPP Project

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test-macos:
    strategy:
      matrix:
        os: [ macos-15-intel ]
        arch: [ x64 ]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 2.7
        run: |
          brew install pyenv
          pyenv install 2.7.18
          pyenv global 2.7.18
          echo "$(pyenv root)/shims" >> $GITHUB_PATH

      - name: Setup cocos2d-x Environment
        run: |
          python --version
          echo "" | python setup.py

      - name: Initialize Project
        run: |
          source /Users/runner/.bash_profile
          echo "N" | cocos new -l cpp aaa

      - name: Setup Project
        run: |
          cd aaa
          cmake -B build -G"Xcode" --log-level=STATUS
      
      - name: Build Project
        run: |
          cd aaa
          cmake --build build --config Release

  test-windows:
    strategy:
      matrix:
        os: [ windows-2022 ]
        arch: [ x64 ]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 2.7
        run: |
          choco install python2 -version 2.7.18
          $env:PATH = "C:\Python27;C:\Python27\Scripts;$env:PATH"

      - name: Run Main
        run: |
          $env:PATH = "C:\Python27;C:\Python27\Scripts;$env:PATH"
          echo "" | python setup.py

      - name: Initialize Project
        run: |
          # Add Python 2.7 to PATH
          $env:PATH = "C:\Python27;C:\Python27\Scripts;$env:PATH"

          # Add cocos2d-x Environments
          $env:PATH = "D:\a\cocos2d-x-v3\cocos2d-x-v3\tools\cocos2d-console\bin;$env:PATH"
          $env:COCOS_CONSOLE_ROOT = "D:\a\cocos2d-x-v3\cocos2d-x-v3\tools\cocos2d-console\bin"
          $env:COCOS_X_ROOT = "D:\a\cocos2d-x-v3"
          $env:COCOS_TEMPLATES_ROOT = "D:\a\cocos2d-x-v3\cocos2d-x-v3\templates"

          echo "N" | cocos new -l cpp aaa

      - name: Setup Project
        run: |
          cd aaa
          cmake -B build -G"Visual Studio 17 2022" -A x64 --log-level=STATUS

      - name: Build Project
        run: |
          cd aaa
          cmake --build build --config Release